SKETCHYBAR CONFIGURATION - ARCHITECTURE ANALYSIS SUMMARY
========================================================

FILES ANALYZED:
- main.lua (811 lines) - Core configuration
- modules/state.lua (328 lines) - State management
- modules/icons.lua (411 lines) - Icon library
- modules/icon_manager.lua (292 lines) - Multi-font icon support
- modules/menu.lua (444 lines) - Menu system
- modules/c_bridge.lua (310 lines) - C component interface
- modules/component_switcher.lua (382 lines) - Runtime component selection
- modules/widgets.lua - Widget factory (partial)
- plugins/spaces_setup.sh (143 lines) - Space initialization
- plugins/space.sh (207 lines) - Per-space updates
- plugins/front_app.sh (37 lines) - Front app widget
- plugins/set_space_mode.sh (81 lines) - Space mode management
- plugins/refresh_spaces.sh (12 lines) - Space refresh orchestrator
- plugins/menu_action.sh (28 lines) - Menu action wrapper
- plugins/focus_space.sh (14 lines) - Space focus handler
- helpers/popup_hover.c (93 lines) - Menu hover highlighting
- helpers/submenu_hover.c (162 lines) - Submenu coordination
- helpers/popup_guard.c (41 lines) - Parent popup guard
- gui/config_menu_v2.m (1562 lines) - Configuration UI


KEY ARCHITECTURE INSIGHTS:
==========================

1. EVENT-DRIVEN MULTI-TIER SYSTEM
   SketchyBar Events → Lua Configuration → Shell Scripts → C Binaries
   
   a) SketchyBar generates 13+ built-in events:
      - mouse.entered, mouse.exited, mouse.exited.global
      - volume_change, front_app_switched
      - system_woke, power_source_change
      - display_changed, display_added, display_removed
   
   b) Yabai signals trigger via Lua setup:
      - space_changed, space_created, space_destroyed
      - display_changed
   
   c) Custom events created by main.lua:
      - space_change, space_mode_refresh
      - whichkey_toggle, yabai_status_refresh


2. PERSISTENT STATE MANAGEMENT (state.json)
   File: ~/.config/sketchybar/state.json
   
   Contains:
   - widgets: {<widget_name>: <bool>}
   - appearance: {bar_height, corner_radius, blur_radius, widget_scale}
   - icons: {<icon_name>: <glyph>}
   - space_icons: {<space_num>: <icon>}
   - space_modes: {<space_num>: "float"|"bsp"|"stack"}
   - widget_colors: {<widget_name>: <color>}
   - integrations: {yaze, emacs, halext configs}
   
   Access Pattern:
   - Read: main.lua, all scripts, config GUI
   - Write: config GUI, scripts (Python inline)
   - Atomicity: Python json.dump provides some safety


3. ICON RESOLUTION CHAIN (4-tier fallback)
   
   icon_for(name, fallback) resolves in order:
   1. State icons (state.json): custom user-provided
   2. Icon Manager: multi-font system (Hack Nerd → SF Pro → SF Symbols)
   3. Legacy Icons Module: categorical library (backward compat)
   4. Provided fallback: empty string or specified icon
   
   Space Icons Additional Layer:
   - Priority: custom icon > app icon > indicator (• or ○)


4. SPACE LIFECYCLE MANAGEMENT
   
   Creation:
   Yabai signal → refresh_spaces.sh → spaces_setup.sh
   ├─ Removes all space.* items
   ├─ Queries yabai for current spaces
   ├─ Reads custom icons from state.json
   ├─ Creates space items with attached space.sh
   └─ Subscribes to: mouse.entered, mouse.exited, space_change, space_mode_refresh
   
   Update:
   Event (space_change, space_mode_refresh) → space.sh
   ├─ Reads state.json (space_icons, space_modes)
   ├─ Queries yabai for active app
   ├─ Resolves icon
   ├─ Ensures layout mode matches desired state
   └─ Updates widget display
   
   Mode Management:
   GUI/Script → set_space_mode.sh
   ├─ Updates state.json (space_modes)
   ├─ Applies layout: yabai -m space <N> --layout <mode>
   ├─ Triggers space_mode_refresh
   └─ space.sh verifies sync


5. MENU SYSTEM WITH SUBMENU COORDINATION
   
   Files:
   - modules/menu.lua: Renders menu structure
   - helpers/submenu_hover.c: Handles hover timing
   - helpers/popup_guard.c: Prevents premature closing
   
   Flow:
   User hovers on submenu parent
   → submenu_hover.c (mouse.entered)
     ├─ Close other submenus
     ├─ Write /tmp/sketchybar_submenu_active
     ├─ Write /tmp/sketchybar_parent_popup_lock
     └─ Open submenu popup
   
   User exits submenu
   → submenu_hover.c (mouse.exited)
     ├─ Fork background process
     ├─ Wait CLOSE_DELAY (0.25s default)
     ├─ Check if still active
     └─ If not: close submenu, clean /tmp files
   
   Parent popup tries to close
   → popup_guard.c
     ├─ Check for /tmp/sketchybar_parent_popup_lock
     ├─ If exists: do nothing (submenu still open)
     └─ If missing: close parent popup


6. FRONT APP WIDGET
   
   Event: front_app_switched (built-in SketchyBar)
   
   Script: plugins/front_app.sh
   ├─ Gets current front app name
   ├─ Filters out SketchyBar's own apps
   ├─ Calls app_icon.sh to get icon
   └─ Updates label and icon
   
   Menu: Dynamically populated with app-specific actions


7. GUI CONFIGURATION (Objective-C Cocoa)
   
   File: gui/config_menu_v2.m (1562 lines)
   
   Components:
   - ConfigurationManager: Singleton for state.json I/O
   - AppearanceTab: Bar height, corner radius, blur, scale
   - SpacesTab: Custom icons and layout modes per space
   - IconsTab: Icon browser and search
   - ToggleTab: Feature toggles
   - ThemesTab: Theme selection
   
   Data Flow:
   User input → SpacesTabViewController.applySettings()
   → ConfigurationManager.setValue(keyPath, value)
   → state.json written atomically
   → Optionally: set_space_mode.sh called
   → sketchybar --reload triggered
   → main.lua re-evaluates with new state


8. HYBRID C/LUA ARCHITECTURE
   
   Components:
   - c_bridge.lua: Lightweight wrapper for C binaries
   - component_switcher.lua: Runtime selection with fallback
   
   Modes:
   - "auto": Use C if available, fallback to Lua
   - "c": Force C implementation
   - "lua": Force Lua implementation
   - "hybrid": Each component chooses independently
   
   Features:
   - Performance statistics tracking
   - Auto-fallback on C failure
   - Configurable via component_settings.json
   
   C Components Available:
   - icon_manager: Fast icon lookup
   - state_manager: State file operations
   - widget_manager: Widget updates
   - menu_renderer: Menu rendering


CRITICAL ISSUES IDENTIFIED:
===========================

1. SUBMENU HOVER TIMING RACE (CRITICAL)
   File: helpers/submenu_hover.c, schedule_close()
   
   Issue: Background process checks /tmp file with delay
   - If user re-enters submenu at CLOSE_DELAY + epsilon
   - Multiple submenus might try to close simultaneously
   - Race condition between closing and parent popup dismissal
   
   Impact: Submenu might close unexpectedly during navigation


2. SPACE ICON STATE COHERENCE
   File: plugins/spaces_setup.sh
   
   Issue: Reads state.json once, then processes all spaces
   - If state.json modified during execution
   - Some spaces get old icons, others get new
   - GUI shows different state than bar
   
   Impact: Space icons inconsistent after rapid updates


3. SPACE MODE TIMING
   File: plugins/set_space_mode.sh
   
   Issue: Sequential operations without synchronization
   - state.json updated
   - yabai command sent (may be async)
   - space_mode_refresh triggered immediately
   - space.sh might read old state before Yabai completes
   
   Impact: Wrong mode icon displayed temporarily


4. COMPONENT SWITCHER SILENT FALLBACK
   File: modules/component_switcher.lua
   
   Issue: C failures silently fallback to Lua
   - No user notification
   - Performance statistics misleading
   - Hard to debug failures
   
   Impact: Difficult to diagnose component issues


5. ICON VALIDATION MISSING
   File: main.lua safe_icon(), gui/config_menu_v2.m
   
   Issue: state.json input not validated
   - config_menu_v2.m saves icon without checking UTF-8
   - main.lua validates on read, silently drops bad icons
   - User gets no feedback
   
   Impact: Silent data loss of custom icons


6. POPUP DISMISSAL RACE WITH SPACE CHANGE
   File: main.lua popup_manager
   
   Issue: popup_manager and space.sh both subscribe to space_change
   - Execution order undefined
   - popup_manager might close before space.sh updates icons
   - Or space.sh updates in old space while popup_manager closes
   
   Impact: Popups not dismissed cleanly on space change


SYNCHRONIZATION POINTS:
=======================

State Files:
- ~/.config/sketchybar/state.json (atomic writes)
- /tmp/sketchybar_submenu_active (menu hover state)
- /tmp/sketchybar_parent_popup_lock (parent close guard)
- /tmp/sketchybar_popup_state/active_parent (parent tracking)

Event Dependencies:
- space_change → space.sh → state.json reads
- space_mode_refresh → space.sh ensures_layout
- front_app_switched → front_app.sh updates
- mouse.entered/exited → hover effects

Yabai Integration:
- Yabai signals configured in main.lua watch_spaces()
- Scripts query Yabai via: yabai -m query --spaces
- Layout changes: yabai -m space <N> --layout <mode>


INFORMATION FLOW SUMMARY:
=========================

System Events
    ↓
SketchyBar Trigger
    ↓ (event dispatch)
Lua Script Handler / Subscribed Item
    ↓ (plugin execution)
Shell Script / Python Inline
    ↓ (state manipulation)
state.json Update / Yabai Command
    ↓ (external effects)
Bar Refresh / Window Manager Update
    ↓ (visual result)
User Sees Change


RECOMMENDATIONS FOR HARDENING:
===============================

1. Add file locking to state.json writes (flock)
2. Implement atomic writes (temp file + rename)
3. Add event sequencing/ordering guarantees
4. Validate all user input before saving
5. Add comprehensive logging to debug file
6. Implement timeouts on all external commands
7. Add state.json version field for migrations
8. Graceful degradation when files corrupted
9. IPC alternative to /tmp file coordination
10. Unit tests for component interactions


KEY ARCHITECTURAL METRICS:
==========================

Lines of Code:
- Lua: ~3,200 lines (main + modules)
- Shell: ~500 lines (plugins)
- Objective-C: ~1,600 lines (GUI)
- C: ~800 lines (helpers + components)

Event Subscriptions: 13+ sources, 20+ subscriptions
Component Count: 40+ Lua modules/scripts, 8 C components
External Dependencies: Yabai, SketchyBar, Python3, jq

Update Frequency:
- space.sh: Per space_change event (frequent)
- front_app.sh: Per front_app_switched (frequent)
- space_setup.sh: Per space lifecycle (infrequent)
- GUI: On user interaction (as needed)


DOCUMENTATION FILES CREATED:
============================

1. ARCHITECTURE_ANALYSIS.md (983 lines)
   - Comprehensive breakdown of all components
   - Event flows and sequences
   - Data flow diagrams in text
   - Race conditions and timing issues
   - Recommendations

2. ARCHITECTURE_DIAGRAMS.md (300+ lines)
   - Visual ASCII diagrams
   - Component relationships
   - Event flow sequences
   - State machine diagrams
   - Data synchronization flows

3. ARCHITECTURE_SUMMARY.txt (this file)
   - Quick reference
   - Key insights
   - Critical issues
   - Metrics and recommendations
